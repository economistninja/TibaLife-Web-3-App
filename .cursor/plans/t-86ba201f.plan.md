<!-- 86ba201f-16d3-40aa-81b0-d84f4dd31fb1 22c6e8c1-6541-4297-92e9-4a8440418730 -->
# TibaLife v1 — One-Day Build Plan

## Scope & Priorities

- Backend-first: Auth, FHIR/openEHR-aligned models, consent flows, GridFS storage, on-chain consent/audit hashes, USSD/SMS registration, AMR B2B endpoints.
- Frontend: Landing, Login/Register (Google), 3 dashboards (Patient, Doctor, Hospital), record sharing UI, AMR audit nav.
- Web3: Ethereum + MetaMask, minimal Solidity contracts (ConsentRegistry, AuditTrail), ethers.js integration.
- Zero budget: MongoDB Atlas free, Africa’s Talking Sandbox for USSD/SMS, Google OAuth, IP is local dev; no paid infra.

References

- FHIR APIs: `https://digital.nhs.uk/services/fhir-apis`
- openEHR: `https://openehr.org/`
- WHO AMR facts (for audit KPIs): `https://www.who.int/news-room/fact-sheets/detail/antimicrobial-resistance`
- Blockchain Explorer API (reference only): `https://www.blockchain.com/explorer/api`
- TypeScript: `https://www.typescriptlang.org/docs/`
- React: `https://react.dev/learn`
- Tailwind v2: `https://v2.tailwindcss.com/docs`
- shadcn/ui: `https://ui.shadcn.com/docs`
- Radix UI: `https://www.radix-ui.com/primitives/docs/overview/introduction`
- YouTube refs (inspiration): `https://youtu.be/aoxHhSXDc8Y?si=FY6QD9FOCLFWm-3_`, `https://youtu.be/Wn_Kb3MR_cU?si=kRkoMh0RfDqWn2e2`, `https://youtu.be/4627f2D5Ywk?si=Vs1YCmPlzxeOU_2Q`, `https://youtu.be/BDCT6TYLYdI?si=gMWyqrCLFw07yYUd`

## Architecture

- Backend: Node.js + Express + TypeScript; MongoDB Atlas (Mongoose); GridFS for binary documents; Passport (Google OAuth) + JWT; Africa’s Talking sandbox webhook for USSD/SMS; ethers.js for on-chain.
- Smart contracts: Solidity, minimal `ConsentRegistry` (ERC-5267-like metadata pattern), `AuditTrail` for consent/share events; deploy to local Hardhat and testnet (e.g., Sepolia) if time allows.
- Frontend: React + TypeScript, Vite; Tailwind v2; shadcn/ui + Radix; ethers.js + MetaMask; FHIR resource viewers; role-based dashboards.
- Data storage: Encrypted-at-rest MongoDB; documents via GridFS; on-chain only store content hashes and consent metadata (no PHI on-chain).

## Data Modeling (TypeScript/Mongoose)

- User: { firstName: String, lastName: String, email: String (unique), phone: String, role: 'patient'|'doctor'|'hospital', nationalId: String, walletAddress: String, googleId: String, createdAt, updatedAt }
- Patient: { userId: ObjectId, fhirPatientId: String, demographics: { dob: Date, gender: String, address: String }, contacts: [{ name, relationship, phone }], consentPolicies: [ConsentRef] }
- Doctor (Practitioner): { userId, fhirPractitionerId: String, specialties: [String], organizationId: ObjectId }
- Hospital (Organization): { userId, fhirOrganizationId: String, name: String, mohCode: String, address: String }
- RecordEnvelope: { patientId, fhirResourceType: 'Observation'|'Encounter'|'DocumentReference'|..., fhirResourceId: String, versionId: String, gridFsFileId: ObjectId|null, encrypted: Boolean, checksumSha256: String, createdBy: { doctorId|hospitalId|system }, createdAt }
- Consent: { patientId, granteeType: 'doctor'|'hospital', granteeId, scope: ['read'|'write'|'share'], fhirResourceTypes: [String], validFrom: Date, validTo: Date|null, onChainTxHash: String, consentHash: String, status: 'active'|'revoked', createdAt }
- ShareGrant: { patientId, targetOrgId|doctorId, records: [RecordEnvelopeId], grantedBy: patientId, onChainTxHash: String, createdAt, revokedAt|null }
- AMRAuditEvent: { organizationId, doctorId|null, antibioticCode: String, indication: String, whoAwarenessFlag: Boolean, guidelineRef: String, timestamp: Date, evidenceHash: String, onChainTxHash: String }
- USSDSession: { msisdn: String, sessionId: String, state: String, tempRegistration: { firstName, lastName, nationalId }, createdAt, updatedAt }

FHIR/openEHR Mapping

- FHIR Patient/Practitioner/Organization/Encounter/Observation/DocumentReference resources persisted; `RecordEnvelope` links to FHIR JSON.
- openEHR compositions: represent clinical notes/observations in a normalized composition JSON; store alongside FHIR representation for interoperability.

## Smart Contracts (Solidity outline)

- ConsentRegistry:
- grantConsent(patient, grantee, scopeHash, resourceTypesHash, validTo) → emits ConsentGranted(consentId, hash)
- revokeConsent(consentId) → emits ConsentRevoked
- getConsent(consentId) view
- AuditTrail:
- logShare(patient, grantee, recordHash) → emits ShareLogged
- logAMR(org, antibioticCodeHash, evidenceHash) → emits AMRLogged

Note: Store only hashes/IDs, never PHI.

## API Endpoints (Express)

- Auth: POST /auth/google, GET /auth/google/callback; POST /auth/jwt/refresh; GET /me
- USSD/SMS: POST /ussd/at/callback (Africa’s Talking); POST /sms/at/inbound; POST /sms/at/status
- Users: GET /users/me; PATCH /users/me; GET /users/:id
- FHIR: POST /fhir/:resourceType; GET /fhir/:resourceType/:id; GET /fhir/patient/:patientId/records; POST /fhir/document/upload (GridFS)
- Consent: POST /consent/grant; POST /consent/revoke; GET /consent/my
- Share: POST /share/grant; POST /share/revoke; GET /share/history
- AMR: POST /amr/audit; GET /amr/metrics?orgId=...; GET /amr/antibiotics/top
- Web3: POST /web3/consent/grant (sign & send); GET /web3/tx/:hash

## Compliance & Kenya-specific Notes

- Follow Kenya MOH EMR Standards (interoperability, audit, uptime, role-based access, data exchange). Align FHIR R4 resource profiles.
- ODPC Health Data Guidance (2024): consent, purpose limitation, data minimization, portability; store hashes on-chain only.
- Security: OAuth 2.0 (Google) + JWT; TLS; server-side encryption; per-tenant org scoping; consent checks middleware; structured audit logs.

## Styling & Brand

- Colors: Red Warning (#D32F2F), White (#FFFFFF), Olive Green (#556B2F). Tailwind custom theme tokens.
- Components: shadcn/ui + Radix for forms, dialogs, tabs, data table.

## Image Roadmap (for `app.css`/assets)

- Landing hero: healthcare + tech collage (1920x1080), subtle red/olive gradient overlay.
- Dashboard empty-states: patient folder illustration; doctor stethoscope + ledger; hospital interoperability network diagram.
- AMR banner: bacteria/AMR awareness ribbon (WHO-aligned).
- Favicons/app icons in red/olive theme.

## Deliverables by Day End

- Running backend (auth, FHIR CRUD, GridFS upload, consent/share, USSD/SMS sandbox, AMR audit, web3 tx to local chain).
- Frontend MVP with 3 dashboards and sharing flows.
- Minimal contracts deployed locally; optional testnet deploy if time allows.

## Commands (Windows PowerShell) — to run later

- Node/PNPM setup, create workspaces, install deps, env vars for Google OAuth, MongoDB URI, Africa’s Talking sandbox, Hardhat, run dev servers. (We will provide exact commands during execution.)

## Acceptance Criteria

- Google login works; users created with roles; JWT protects APIs.
- Patient can view FHIR records and share with a doctor/hospital; on-chain consent logs emit tx hash.
- Doctor/hospital can upload DocumentReference, view with consent.
- AMR audit events can be posted and viewed in doctor navbar module.
- USSD/SMS sandbox completes basic registration linking phone → account.
- No PHI on-chain; MongoDB/GridFS holds records; consent checks enforced.

### To-dos

- [ ] Initialize backend (Express TS, Mongoose, Passport Google, JWT)
- [ ] Implement FHIR/openEHR-aligned Mongoose models and GridFS
- [ ] Create Solidity ConsentRegistry and AuditTrail with tests (Hardhat)
- [ ] Integrate ethers.js, MetaMask flow, consent hash signing endpoints
- [ ] Add FHIR CRUD endpoints and document upload
- [ ] Add consent grant/revoke and sharing endpoints with checks
- [ ] Wire Africa’s Talking sandbox USSD/SMS registration flows
- [ ] Implement AMR audit endpoints and metrics
- [ ] Scaffold React TS + Tailwind + shadcn/ui + routing
- [ ] Build patient, doctor, hospital dashboards and nav with AMR
- [ ] Apply red/white/olive theme and assets
- [ ] Run end-to-end locally; optional testnet deploy